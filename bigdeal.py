import telebot
from telebot.types import ReplyKeyboardMarkup, KeyboardButton, Message
import requests
from config import TOKEN_WEATHER, TOKEN_BOT

EMOJI_CODE = {200: '‚õà',
              201: '‚õà',
              202: '‚õà',
              210: 'üå©',
              211: 'üå©',
              212: 'üå©',
              221: 'üå©',
              230: '‚õà',
              231: '‚õà',
              232: '‚õà',
              301: 'üåß',
              302: 'üåß',
              310: 'üåß',
              311: 'üåß',
              312: 'üåß',
              313: 'üåß',
              314: 'üåß',
              321: 'üåß',
              500: 'üåß',
              501: 'üåß',
              502: 'üåß',
              503: 'üåß',
              504: 'üåß',
              511: 'üåß',
              520: 'üåß',
              521: 'üåß',
              522: 'üåß',
              531: 'üåß',
              600: 'üå®',
              601: 'üå®',
              602: 'üå®',
              611: 'üå®',
              612: 'üå®',
              613: 'üå®',
              615: 'üå®',
              616: 'üå®',
              620: 'üå®',
              621: 'üå®',
              622: 'üå®',
              701: 'üå´',
              711: 'üå´',
              721: 'üå´',
              731: 'üå´',
              741: 'üå´',
              751: 'üå´',
              761: 'üå´',
              762: 'üå´',
              771: 'üå´',
              781: 'üå´',
              800: '‚òÄ',
              801: 'üå§',
              802: '‚òÅ',
              803: '‚òÅ',
              804: '‚òÅ'}

URL_WEATHER = 'https://api.openweathermap.org/data/2.5/weather'

bot = telebot.TeleBot(TOKEN_BOT)

keyboard = ReplyKeyboardMarkup()
keyboard.add(KeyboardButton('–ü–æ–ª—É—á–∏—Ç—å –ø–æ–≥–æ–¥—É', request_location=True))
keyboard.add(KeyboardButton('–û –ø—Ä–æ–µ–∫—Ç–µ'))

'''–°—é–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É (ReplyKeyboardMarkup, KeyboardButton)'''


@bot.message_handler(commands=['start'])
def send_about(message: Message):
    """
    –ù–∞ –∫–æ–º–∞–Ω–¥—É start –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    "–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Å–≤–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏ —è –æ—Ç–ø—Ä–∞–≤–ª—é —Ç–µ–±–µ –ø–æ–≥–æ–¥—É."
    –∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É.
    """
    bot.send_message(message.chat.id, '–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Å–≤–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏ —è –æ—Ç–ø—Ä–∞–≤–ª—é —Ç–µ–±–µ –ø–æ–≥–æ–¥—É', reply_markup=keyboard)


@bot.message_handler(regexp='–û –ø—Ä–æ–µ–∫—Ç–µ')
def send_welcome(message: Message):
    """
    –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É "–û –ø—Ä–æ–µ–∫—Ç–µ" –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    "–ë–æ—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –ø–æ–≥–æ–¥—É –≤ —Ç–µ–∫—É—â–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏!
    –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã - –æ—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é.
    –ü–æ–≥–æ–¥–∞ –±–µ—Ä–µ—Ç—Å—è —Å —Å–∞–π—Ç–∞ https://openweathermap.org."
    –∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º —Å–Ω–æ–≤–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É. –î–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä "regexp='–û –ø—Ä–æ–µ–∫—Ç–µ'". –ü–æ—Å–∫–æ–ª—å–∫—É
    –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–û –ø—Ä–æ–µ–∫—Ç–µ" —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, —Ç–æ –Ω—É–∂–Ω–æ
    –ø—Ä–∏–º–µ–Ω—è—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.
    """
    bot.send_message(message.chat.id, '''
    –ë–æ—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –ø–æ–≥–æ–¥—É –≤ —Ç–µ–∫—É—â–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏!
    –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã - –æ—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é.
    –ü–æ–≥–æ–¥–∞ –±–µ—Ä–µ—Ç—Å—è —Å —Å–∞–π—Ç–∞ https://openweathermap.org
    ''', reply_markup=keyboard)


def get_weather(lat, lon):
    """
    –ü—Ä–æ—Å—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ send_weather.
    –ó–¥–µ—Å—å –Ω–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–≥–æ–¥—ã –∏–º–µ—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã(–∫–æ—Ç–æ—Ä—ã–µ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è
    –≤ send_weather), —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –∫–∞–∫ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ —Å–ª–∞–π–¥–∞
    https://disk.yandex.ru/i/J8iMnJNFzzL7SQ –¥–æ–±–∞–≤–∏–≤ –∏–∫–æ–Ω–∫–∏ üèô üå° üíß –∏ —ç–º–æ–¥–∑–∏,
    –∞ –ø–æ—Ç–æ–º —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å —ç—Ç—É —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É.
    """
    params = {
        'appid': TOKEN_WEATHER,
        'lat': lat,
        'lon': lon,
        'units': 'metric',
        'lang': 'ru'
    }
    response = requests.get(URL_WEATHER, params=params).json()
    city_name = response['name']
    description = response['weather'][0]['description']
    code = response['weather'][0]['id']
    emoji = EMOJI_CODE.get(code)
    temp = response['main']['temp']
    temp_feels = response['main']['feels_like']
    humidity = response['main']['humidity']
    text = f'''
    üèô –ü–æ–≥–æ–¥–∞ –≤: {city_name}\n
    {emoji} {description}\n
    üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ {round(temp)}¬∞C\n
    üå° –û—â—É—â–∞–µ—Ç—Å—è {temp_feels}¬∞C\n
    üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å {humidity}%. \n
'''
    return text


@bot.message_handler(content_types=['location'])
def send_weather(message: Message):
    """
    –ó–¥–µ—Å—å –∏–∑ –æ–±—ä–µ–∫—Ç–∞ message –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º–µ—Å—Ç–Ω–æ—Å—Ç–∏
    –∏ –≤—ã–∑—ã–≤–∞—è get_weather –ø–µ—Ä–µ–¥–∞–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã. –ü–æ–ª—É—á–∏–≤ –æ—Ç
    —Ñ—É–Ω–∫—Ü–∏–∏ get_weather —Å—Ç—Ä–æ–∫—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ—ë –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –Ω–µ –∑–∞–±—ã–≤–∞–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
    –°–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ, —á—Ç–æ–±—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–æ–±–∞–≤–∏–ª–∏—Å—å –≤ –æ–±—ä–µ–∫—Ç message,
    —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞–¥–æ —É–∫–∞–∑–∞—Ç—å content_types=['location'].
    –ò –µ—â–µ –æ–¥–Ω–æ –≥–ª–∞–≤–Ω–æ–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–æ–∑–¥–∞–Ω–∏—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.
    –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã KeyboardButton('–ü–æ–ª—É—á–∏—Ç—å –ø–æ–≥–æ–¥—É', request_location=True),
    –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä request_location, –∫–æ—Ç–æ—Ä—ã–π –æ–∑–Ω–∞—á–∞–µ—Ç,
    —á—Ç–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É "–ü–æ–ª—É—á–∏—Ç—å –ø–æ–≥–æ–¥—É" —Ç–µ–ª–µ–≥—Ä–∞–º –ø—Ä–æ—Å–∏—Ç
    –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â—É—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é. –ü–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
    –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ –æ–±—ä–µ–∫—Ç message –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã.
    """
    lat = message.location.latitude
    lon = message.location.longitude
    text: str = get_weather(lat, lon)
    if text:
        bot.send_message(message.chat.id, text, reply_markup=keyboard)


bot.infinity_polling()
